<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Route Planner Test</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <style>
        body { margin: 0; padding: 0; }
        #map { height: 100vh; }
        .info {
            position: fixed;
            top: 10px;
            right: 10px;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="info">
        <h3>Simple Route Planner Test</h3>
        <p>Click on the map to add waypoints</p>
        <button onclick="clearWaypoints()">Clear Waypoints</button>
        <div id="status"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    
    <script>
        // Initialize map
        const map = L.map('map').setView([37.7749, -122.4194], 13);
        
        // Add tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);
        
        // Store waypoints
        let waypoints = [];
        let markers = [];
        let routingControl = null;
        
        // Click handler
        map.on('click', function(e) {
            addWaypoint(e.latlng);
        });
        
        function addWaypoint(latlng) {
            const marker = L.marker(latlng, {
                draggable: true
            }).addTo(map);
            
            markers.push(marker);
            waypoints.push(latlng);
            
            // Update status
            document.getElementById('status').innerHTML = `Waypoints: ${waypoints.length}`;
            
            // Calculate route if we have at least 2 waypoints
            if (waypoints.length >= 2) {
                calculateRoute();
            }
            
            // Handle marker drag
            marker.on('dragend', function(e) {
                const index = markers.indexOf(marker);
                waypoints[index] = e.target.getLatLng();
                if (waypoints.length >= 2) {
                    calculateRoute();
                }
            });
        }
        
        function calculateRoute() {
            // Remove existing routing control
            if (routingControl) {
                map.removeControl(routingControl);
            }
            
            // Create new routing control
            routingControl = L.Routing.control({
                waypoints: waypoints,
                router: L.Routing.osrmv1({
                    serviceUrl: 'https://router.project-osrm.org/route/v1'
                }),
                createMarker: function() { return null; }, // We manage our own markers
                lineOptions: {
                    styles: [{ color: '#4F46E5', weight: 6, opacity: 0.8 }]
                },
                show: false,
                addWaypoints: false
            }).addTo(map);
            
            routingControl.on('routesfound', function(e) {
                const routes = e.routes;
                console.log('Found', routes.length, 'route(s).');
                if (routes[0]) {
                    const distance = (routes[0].summary.totalDistance / 1000).toFixed(1);
                    const time = Math.round(routes[0].summary.totalTime / 60);
                    document.getElementById('status').innerHTML = 
                        `Waypoints: ${waypoints.length}<br>
                         Distance: ${distance} km<br>
                         Time: ${time} minutes`;
                }
            });
            
            routingControl.on('routingerror', function(e) {
                console.error('Routing error:', e);
                document.getElementById('status').innerHTML = 
                    `Waypoints: ${waypoints.length}<br>
                     <span style="color: red;">Routing error!</span>`;
            });
        }
        
        function clearWaypoints() {
            // Remove markers
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            waypoints = [];
            
            // Remove routing
            if (routingControl) {
                map.removeControl(routingControl);
                routingControl = null;
            }
            
            document.getElementById('status').innerHTML = 'Waypoints: 0';
        }
        
        // Test with automatic waypoints
        setTimeout(() => {
            console.log('Adding test waypoints...');
            addWaypoint(L.latLng(37.7749, -122.4194)); // San Francisco
            addWaypoint(L.latLng(37.7849, -122.4094)); // Slightly north
        }, 1000);
    </script>
</body>
</html>