<!DOCTYPE html>
<html lang="en">
<head>
    {% include "head.njk" %}
    
    {# A/B Test Setup Script - Must run before body renders #}
    <script>
    (function() {
        // Check for preview mode
        const urlParams = new URLSearchParams(window.location.search);
        const previewVariant = urlParams.get('preview');
        
        if (previewVariant) {
            // Force specific variant for preview
            localStorage.setItem('ab_test_group', previewVariant);
        } else {
            // Regular A/B test assignment
            let testGroup = localStorage.getItem('ab_test_group');
            
            if (!testGroup) {
                testGroup = Math.random() < 0.5 ? 'control' : 'variant';
                localStorage.setItem('ab_test_group', testGroup);
                
                // Track assignment
                if (typeof gtag !== 'undefined') {
                    gtag('event', 'ab_test_assigned', {
                        'test_name': 'header_sidebar_redesign',
                        'variant': testGroup
                    });
                }
            }
        }
        
        // Add class to html element for immediate styling
        document.documentElement.classList.add('ab-test-' + (localStorage.getItem('ab_test_group') || 'control'));
    })();
    </script>
    
    {# Include V2 styles if needed #}
    <link rel="stylesheet" href="/assets/css/header-sidebar-v2.css">
</head>
<body{% if bodyClass %} class="{{ bodyClass }}"{% endif %}>
    {% include "background-canvas.njk" %}
    
    {# Conditionally include header based on A/B test #}
    <script>
        const variant = localStorage.getItem('ab_test_group') || 'control';
        window.abTestGroup = variant;
    </script>
    
    {% raw %}
    <script>
        if (window.abTestGroup === 'variant') {
            document.write(`{% include "main-header-v2.njk" %}`);
        } else {
            document.write(`{% include "main-header.njk" %}`);
        }
    </script>
    {% endraw %}
    
    {{ content | safe }}
    
    {% include "scripts.njk" %}
    
    {# Include A/B test analytics #}
    <script src="/assets/js/ab-test-analytics.js"></script>
</body>
</html>