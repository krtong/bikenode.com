#!/bin/bash
# Reopen a previously closed chatroom

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
INSTANCE_ID="${CLAUDE_INSTANCE_ID:-instance-3}"

# Source logging function
source "$SCRIPT_DIR/log-action"

# Main logic
if [ $# -lt 2 ]; then
    echo "Usage: reopen-chatroom <chatroom-name> <reason>"
    echo "Example: reopen-chatroom temp-discussion 'Project reactivated, need to continue discussions'"
    echo ""
    echo "Available closed chatrooms:"
    if [ -d "$SCRIPT_DIR/chatrooms/closed" ]; then
        ls "$SCRIPT_DIR/chatrooms/closed/" 2>/dev/null | grep -o '^[^_]*' | sort -u
    else
        echo "  (none)"
    fi
    exit 1
fi

CHATROOM_NAME="$1"
REOPEN_REASON="${@:2}"
CLOSED_DIR="$SCRIPT_DIR/chatrooms/closed"
TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')

# Find the most recent closed file for this chatroom
CLOSED_FILE=$(ls -t "$CLOSED_DIR/${CHATROOM_NAME}_closed_"*.txt 2>/dev/null | head -1)

if [ -z "$CLOSED_FILE" ]; then
    echo "ERROR: No closed chatroom found with name '$CHATROOM_NAME'"
    log_action "REOPEN_CHATROOM_FAILED" "Not found: $CHATROOM_NAME"
    exit 1
fi

# Check if chatroom already exists (was already reopened)
if [ -f "$SCRIPT_DIR/chatrooms/$CHATROOM_NAME.txt" ]; then
    echo "ERROR: Chatroom '$CHATROOM_NAME' is already open"
    log_action "REOPEN_CHATROOM_FAILED" "Already open: $CHATROOM_NAME"
    exit 1
fi

# Copy the closed chatroom back to active
cp "$CLOSED_FILE" "$SCRIPT_DIR/chatrooms/$CHATROOM_NAME.txt"

# Add reopening notice
echo "" >> "$SCRIPT_DIR/chatrooms/$CHATROOM_NAME.txt"
echo "[CHATROOM REOPENED: $TIMESTAMP by $INSTANCE_ID]" >> "$SCRIPT_DIR/chatrooms/$CHATROOM_NAME.txt"
echo "[REASON: $REOPEN_REASON]" >> "$SCRIPT_DIR/chatrooms/$CHATROOM_NAME.txt"
echo "" >> "$SCRIPT_DIR/chatrooms/$CHATROOM_NAME.txt"

# Recreate inbox directory if needed
mkdir -p "$SCRIPT_DIR/inboxes/$CHATROOM_NAME"

# Log the action
log_action "REOPEN_CHATROOM" "Reopened: $CHATROOM_NAME | Reason: $REOPEN_REASON"

echo "Chatroom '$CHATROOM_NAME' reopened successfully"
echo "Reason: $REOPEN_REASON"
echo "Location: $SCRIPT_DIR/chatrooms/$CHATROOM_NAME.txt"